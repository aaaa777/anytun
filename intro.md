# 学校などのネットワークを回避する方法について

## はじめに

前提として、制限のかかったネットワークというのはそれなりの理由があるから、そうなっています。
例えば動画視聴やWeb会議等の大容量の通信は他人の通信を圧迫するため、ネットワークの安定のために制限することがあります。
あるいは不適切なサイトへのアクセスを防ぎ、ウィルスの感染によるネットワーク内部の被害を防ぐために制限することもあるでしょう。
それらの制限を自ら回避するということは、何が起きても自分の責任であるということを理解してください。
自分がウィルスに感染し、それでネットワーク内部に感染を広げた場合、自分の責任です。
これを見ている人は学生と仮定していますが、社会人の方は絶対に会社でこのようなマネをしないように。
無許可で会社のネットワーク内に使うなど論外です。
何を言ってるのか分からない人や仕組みを把握していない人は絶対にやるべきではありません。
全て自分の管理下で行える人が行ってください。

## 制限された環境

このようなネットワークを回避することを目的とします。

可能な通信
- DHCPで通知されたDNSサーバ(Cisco Umbrellaを想定)へのDNSクエリ
- ブラックリストにないサイト(Google検索や一般的なサイト)へのHTTP/HTTPS通信
- ブラックリストにない自前のドメインへのHTTP/HTTPS通信

不可能な通信
- パブリックDNSサーバ(1.1.1.1や8.8.8.8)へのDNSクエリ
- ブラックリストに登録されたサイト(ゲーム・アダルトサイトなど)へのHTTP/HTTPS通信
- その他一切のプロトコルを利用した通信(SSH, ICMP, L2TP, etc)

備考
- ドメインベースでアクセス制御が掛けられており、DNS問い合わせ無しのIP直接接続は阻まれる
- TLSインスペクションがあり、TLSトンネルを使った通信は不可

## 回避方法

通信を通せるトンネルを作れば基本はどんなネットワークも回避できますが、全てトンネル経由で通信するとネットワーク管理者から回避していることがバレバレになります。
なので、通常の通信はそのまま通し、回避したい通信だけを複数のトンネルに分散して通します。
今回は中国のGFW回避技術を参考にHTTP/HTTPS通信をトンネルとして利用します。

### 利用するツール

今回利用するツール
- v2fly/v2ray: トンネルの作成
- tun2socks: トンネルを利用するためのツール
- coredns: DNSサーバの変更

v2rayとcorednsを選択した理由はfakednsを利用してIPの振り分けを行うためです。

#### v2rayについて

v2rayはGFW回避技術として有名なツールです。
HTTP/HTTPSトンネルを作るためのプロトコルはいくつかありますが、今回はwebsocketとvmessを利用します。

#### tun2socksについて

socks5プロキシを使ってトンネルを作成するためのツールです。